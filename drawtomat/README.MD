# Drawtomat

Drawtomat is a picture generator which creates pictures based on a natural 
language description.

## Installation

To download UDPipe pretreained models use:

```console
$ make udpipe
```

Following command will set up Python virtual environment:

```console
$ make install
```

Then the programme can be executed with following command:

```console
$ make run
```

Or alternatively
```console
$ export PYTHONPATH=src
$ python3 -m drawtomat [-h] [--help]
                       [--description DRAWING_DESCRIPTION]
                       [--graph_output GRAPH_OUTPUT_PATH]
                       [--image_output IMAGE_OUTPUT_PATH]
                       [--show]
```

Or start a HTTP API server:

```console
$ make run-api
```

## Overview

The picture is generated in two phases. These phases are discussed in more 
detail in following sections. 

In the first phase a text description is transformed into a relation graph. 
The graph contains all objects which will be drawn and relations between the 
objects and groups of objects.

The second phases uses relation graph to place objects and compose a scene 
which is then drawn. 

<p align="center">
<img alt="Drawtomat picture generation phases" src="resources/images/phase-diagram.svg" />
</p>

<p align="center">
<i>Diagram of picture generation phases</i>
</p>

Drawtomat user interface is very simple. It takes the standard input as a
description.

```console
$ make run
Description: A dog and a couch are in a house. The dog is on the couch.
```

<p align="center">
<i>Example input</i>
</p>

After receiving the input an image is generated and a window with the image
and relation graph will show up.

<p align="center">
<img height="400" alt="Drawtomat output example" src="resources/images/drawtomat-window.png" />
</p>

<p align="center">
<i>Example output</i>
</p>

## Description Processing

Drawtomat uses *[UDPipe][1]* for tokenization, lemmatization, and dependency 
parsing of the picture description. *UDPipe* produces annotated data in 
*[CoNLL-U Format][2]*. Trained UDPipe models are automatically downloaded and
saved in `resources/udpipe` directory by `udpipe` make target (`run` target 
depends on `udpipe` target).

<p align="center">
<img alt="UDPipe dependency tree" src="resources/images/udpipe-tree.svg" />
</p>

<p align="center">
<i>Dependency tree generated with <a href="http://lindat.mff.cuni.cz/services/udpipe/">UDPipe online service</a></i>
</p>

### Dependency Tree Traversal

Dependency tree generated by *UDPipe* is traversed using depth-first search.

The first objective of the tree traversal is to detect objects which will be
used in the picture. Every noun in the sentence is used to create an object 
which will be used in a relation graph. The object creation takes place during
the node opening. 

After the object is created it is added to an entity stack. An entity can be 
either an object or a group. Groups will be discussed later in this section. 
Each node of the dependency tree has an entity stack frame pointer associated 
with it. The node's pointer points to the top of the stack at the time it was 
opened.

If there is more than a one entity in the entity stack frame during a node 
closing, a group is created which replaces the whole frame.

Adpositions define relations between objects. For every adposition in the 
sentence a relation is created which connects two top entities on the entity
stack. These relations together with entities define the relation graph.

Complex adpositions such as *in front of*, *next to*, etc. consist of
multiple words. Therefore when processing adpositions, context needs to be
taken into account. Drawtomat supports three types of complex adpositions:
1. PP - Preposition Preposition, e.g. *inside of*
2. PNP - Preposition Noun Preposition, e.g. *in front of*
3. AP - Adverb/Adjective Prepositon, e.g. *next to*

Objects from previous sentences can be referenced via definite article *the*.
The most recently created object with matching word associated with it is used.

Adjectives associated with nouns are stored in created objects for future use.

```text
Description: A dog and a couch are in a house.
opening:  house
	new Object(house)
opening:  dog
	new Object(dog)
opening:  A
closing:  A
	Frame:	[]
opening:  couch
	new Object(couch)
opening:  and
closing:  and
	Frame:	[]
opening:  a
closing:  a
	Frame:	[]
closing:  couch
	Frame:	[ObjectEntity(couch)]
closing:  dog
	Frame:	[ObjectEntity(dog), ObjectEntity(couch)]
	new Group(2)
opening:  are
closing:  are
	Frame:	[]
opening:  in
	new Relation(in)
closing:  in
	Frame:	[]
opening:  a
closing:  a
	Frame:	[]
opening:  .
closing:  .
	Frame:	[]
closing:  house
	Frame:	[ObjectEntity(house), GroupEntity(2)]
	new Group(2)
```

<p align="center">
<i>Example sentence tree traversal log</i>
</p>

### Scene Graphs

A scene graph is a directed graph where entities (objects and groups) are the 
nodes and mutual relations between objects are the edges. An example can be
found in the picture below. 

Formally groups can be seen as nodes and object membership in a group is a 
special relation represented by an edge. However, for the sake of simplicity
the groups will be drawn as containers with objects inside in relation graph
diagrams.

Drawtomat allows relation graph export in [dot language][6].

<p align="center">
<img height="350" alt="Relation graph example" src="resources/images/relation-graph.svg" />
</p>
<p align="center">
<i>Example of a relation graph</i>
</p>

## Code Documentation

Code is documented using *[Sphinx][5]*. Documentation can be generated using
following command:

```console
$ make docs
```

&copy; 2020 Peter Grajcar

[1]: http://ufal.mff.cuni.cz/udpipe "UDPipe"
[2]: https://universaldependencies.org/format.html "CoNLL-U Format"
[3]: http://lindat.mff.cuni.cz/services/udpipe/ "UDPipe Online Service"
[4]: https://quickdraw.withgoogle.com/ "Quick, Draw! dataset"
[5]: https://www.sphinx-doc.org/en/master/ "Sphinx Documentation"
[6]: https://graphviz.org/doc/info/lang.html "Graphviz Dot Language"
[7]: https://docs.python.org/3/library/tkinter.html "Tkinter"
